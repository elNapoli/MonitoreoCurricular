\subsection*{Anexo D: Sketch nodo coordinador.}
\addcontentsline{toc}{subsection}{Anexo D: Sketch nodo coordinador.}
\label{anexo-c}

\hbox{}

\begin{verbatim}

//BASE!!!!
#include <XBee.h>
#include <SPI.h>
#include <Ethernet.h>


byte mac[] = { 0x90, 0xA2, 0xDA, 0x0E, 0xE2, 0x39 };
IPAddress ip(192,168,2,64);
//IPAddress server(192,168,2,254);
char server[] = "diegoz.bounceme.net";
EthernetClient client;


XBee xbee = XBee();
XBeeResponse response = XBeeResponse();
// create reusable response objects for responses we expect to handle 
Rx16Response rx16 = Rx16Response();



int signos, grados = 0;
uint16_t addr16 = 0;
String direccion16 = "";
float longitud,latitud;
int largoPkt = 0;


uint8_t text[10] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

void setup() {
  // put your setup code here, to run once:
    Serial.begin(9600);
    xbee.setSerial(Serial);

    if (Ethernet.begin(mac) == 0) {
      Serial.println("Failed to configure Ethernet using DHCP");
      // no point in carrying on, so do nothing forevermore:
      // try to congifure using IP address instead of DHCP:
      Ethernet.begin(mac, ip);
  }

}

void loop() {
  xbee.readPacket();
  // put your main code here, to run repeatedly:
  if (xbee.getResponse().isAvailable()) {
    if (xbee.getResponse().getApiId() == RX_16_RESPONSE) {
      //primero es lo primero, pescar el paquete
      xbee.getResponse().getRx16Response(rx16);
      largoPkt = rx16.getDataLength();
      direccion16 = "";
      float longitud,latitud = 0;
      int grados = 0;
      //direccion del xbee
      addr16 = rx16.getRemoteAddress16();
      direccion16 = String(addr16, HEX);
      Serial.println(largoPkt);
      if (largoPkt == 2){

        alta(direccion16);

      } else if (pargoPkt == 3) {

        alerta(direccion16);

      } else if (largoPkt == 10){
      //elemento de signos de mediciones
        signos = rx16.getData(0);
        //longitud, parte entera
        longitud = rx16.getData(1);
        //longitud, primeros dos decimales
        longitud = longitud + 0.01*(rx16.getData(2));
        //longitud, tercer y cuarto decimal
        longitud = longitud + 0.0001*(rx16.getData(3));
        //latitud, parte entera
        latitud = rx16.getData(4);
        //latitud, primeros dos decimales
        latitud = latitud + 0.01*(rx16.getData(5));
        //latitud, tercer y cuarto decimal
        latitud = latitud + 0.0001*(rx16.getData(6));
        //grados de brujula con respecto al norte
        grados = rx16.getData(7); 
        postproceso(signos,longitud,latitud,grados,direccion16);
      }
    }
  }
}

void alta(String addrFinal){
  if(client.connect(server, 80)>0) {

    Serial.println("Connectando Alta");
    client.print("GET http://diegoz.bounceme.net/alta.php?addr=");
    client.print(addrFinal);
    client.println(" HTTP/1.1");
    client.println("Host: www.server.com");
    client.println();
    Serial.println();
  } else {
    Serial.println("Connection unsuccesfull");
  }
  client.stop();
  while(client.status() != 0){
    delay(5);
  }

}

void alerta(String addrFinal){
  if(client.connect(server, 80)>0) {

    Serial.println("Connectando Alerta");
    client.print("GET http://diegoz.bounceme.net/alerta.php?addr=");
    client.print(addrFinal);
    client.println(" HTTP/1.1");
    client.println("Host: www.server.com");
    client.println();
    Serial.println();
  } else {
    Serial.println("Connection unsuccesfull");
  }
  client.stop();
  while(client.status() != 0){
    delay(5);
  }

}

void postproceso(int sign,float lon,float lat, int grad, String address){
  //si ambos son negativos, grados menor a 255
  int flag,gradoFinal = 0;
  float lonFinal, latFinal = 0;
  if (sign > 9){
    flag = sign - 10;
    gradoFinal = grad + 255;
  } else {
    flag = sign;
    gradoFinal = grad;
  }
  //parseo de acuerdo a codigo de end device
  if (flag == 0){
    lonFinal = lon*(-1);
    latFinal = lat*(-1);
  } else if (flag == 1){
    lonFinal = lon*(-1);
    latFinal = lat;
  } else if (flag == 2){
    lonFinal = lon;
    latFinal = lat*(-1);
  } else if (flag == 3){
    lonFinal = lon;
    latFinal = lat;
  }
  sending(gradoFinal,lonFinal,latFinal,address);
}

void sending(int gradFinal, float lonFinal, float latFinal, String addrFinal){

  if(client.connect(server, 80)>0) {
    Serial.println("Connected Data");
    client.print("GET http://diegoz.bounceme.net/data.php?addr=");
    client.print(addrFinal);
    client.print("&");
    client.print("heading=");
    client.print(gradFinal);
    client.print("&");
    client.print("lon=");
    client.print(lonFinal,HEX);
    client.print("&");
    client.print("lat=");
    client.print(latFinal,HEX);
    client.println(" HTTP/1.1");
    client.println("Host: www.server.com");
    client.println();
    Serial.println();
  } else {
    Serial.println("Connection unsuccesfull");
  }
  client.stop();
  while(client.status() != 0){
    delay(5);
  }
}

\end{verbatim}